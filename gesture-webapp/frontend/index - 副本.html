<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®æ—¶æ‰‹åŠ¿è¯†åˆ«</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; }
        #container { position: relative; width: 640px; height: 480px; border: 2px solid #333; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #result { margin-top: 20px; font-size: 4em; color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>ğŸ–ï¸ æ‰‹åŠ¿åª’ä½“æ’­æ”¾å™¨ ğŸ–ï¸</h1>
        <div id="video-container">
            <video id="webcam" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>
        <div id="result-card" class="waiting">
            <h2>å½“å‰æ‰‹åŠ¿</h2>
            <div id="result-text">ç­‰å¾…ä¸­...</div>
        </div>
    </div>

    <!-- æ–°å¢çš„åª’ä½“æ’­æ”¾å™¨å’Œæ§åˆ¶å° -->
    <div class="tool-container">
        <video id="player" src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" controls width="640"></video>
        <div class="controls-info">
            <h3>æ§åˆ¶æŒ‡ä»¤</h3>
            <p><strong>æ‰‹åŠ¿ 1:</strong> æ’­æ”¾ / æš‚åœ</p>
            <p><strong>æ‰‹åŠ¿ 2:</strong> åé€€ 5 ç§’</p>
            <p><strong>æ‰‹åŠ¿ 3:</strong> å¿«è¿› 5 ç§’</p>
            <p><strong>æ‰‹åŠ¿ 4:</strong> å‡å°éŸ³é‡</p>
            <p><strong>æ‰‹åŠ¿ 5:</strong> å¢å¤§éŸ³é‡</p>
        </div>
    </div>

    <!-- éœ€è¦ä¸ºæ–°å…ƒç´ æ·»åŠ ä¸€äº›æ ·å¼ -->
    <style>
        /* ... (ä¿ç•™ä¹‹å‰æ‰€æœ‰çš„æ ·å¼) ... */
        .tool-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            align-items: center;
        }
        #player {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .controls-info {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>

    <script>
        // è·å–æ‰€æœ‰éœ€è¦çš„å…ƒç´ 
        const webcam = document.getElementById('webcam'); // ä¿®æ”¹äº†æ‘„åƒå¤´videoçš„ID
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const resultCard = document.getElementById('result-card');
        const resultText = document.getElementById('result-text');
        const player = document.getElementById('player'); // æ–°å¢çš„æ’­æ”¾å™¨

        // --- WebSocket å’Œæ‘„åƒå¤´è®¾ç½®éƒ¨åˆ†ä¸ä¹‹å‰å®Œå…¨ç›¸åŒ ---
        const ws = new WebSocket('ws://127.0.0.1:8000/ws');
        ws.onopen = () => console.log('æˆåŠŸè¿æ¥åˆ°WebSocketæœåŠ¡å™¨!');
        // ... (onclose, onerror) ...

        // !!! æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ !!!
        let lastActionTime = 0; // ç”¨äºé˜²æ­¢æ‰‹åŠ¿é‡å¤è§¦å‘
        const actionCooldown = 1000; // 1ç§’å†·å´æ—¶é—´

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            resultCard.classList.remove('waiting');
            resultText.textContent = `${data.gesture}`;
            resultText.style.color = data.confidence > 0.9 ? 'var(--primary-color)' : 'var(--danger-color)';

            const currentTime = Date.now();
            if (currentTime - lastActionTime < actionCooldown) {
                return; // å¦‚æœè¿˜åœ¨å†·å´æ—¶é—´å†…ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            }

            // æ ¹æ®æ‰‹åŠ¿æ§åˆ¶æ’­æ”¾å™¨
            if (data.confidence > 0.9) { // åªåœ¨ç½®ä¿¡åº¦é«˜æ—¶æ‰§è¡Œ
                let actionTaken = false;
                switch (data.gesture) {
                    case 1:
                        player.paused ? player.play() : player.pause();
                        actionTaken = true;
                        break;
                    case 2:
                        player.currentTime -= 5;
                        actionTaken = true;
                        break;
                    case 3:
                        player.currentTime += 5;
                        actionTaken = true;
                        break;
                    case 4:
                        player.volume = Math.max(0, player.volume - 0.1);
                        actionTaken = true;
                        break;
                    case 5:
                        player.volume = Math.min(1, player.volume + 0.1);
                        actionTaken = true;
                        break;
                }
                if (actionTaken) {
                    lastActionTime = currentTime; // å¦‚æœæ‰§è¡Œäº†æ“ä½œï¼Œåˆ™æ›´æ–°æ—¶é—´æˆ³
                }
            }
        };

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcam.srcObject = stream;
        }

        function sendFrame() {
            canvas.width = webcam.videoWidth;
            canvas.height = webcam.videoHeight;
            ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
                if (ws.readyState === WebSocket.OPEN) ws.send(blob);
            }, 'image/jpeg', 0.5);
        }

        setupCamera().then(() => {
            webcam.onloadedmetadata = () => {
                setInterval(sendFrame, 100);
            };
        });
    </script>
</body>
</html>