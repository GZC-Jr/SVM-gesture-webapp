<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>实时手势识别</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; }
        #container { position: relative; width: 640px; height: 480px; border: 2px solid #333; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #result { margin-top: 20px; font-size: 4em; color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>🖐️ 手势媒体播放器 🖐️</h1>
        <div id="video-container">
            <video id="webcam" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>
        <div id="result-card" class="waiting">
            <h2>当前手势</h2>
            <div id="result-text">等待中...</div>
        </div>
    </div>

    <!-- 新增的媒体播放器和控制台 -->
    <div class="tool-container">
        <video id="player" src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" controls width="640"></video>
        <div class="controls-info">
            <h3>控制指令</h3>
            <p><strong>手势 1:</strong> 播放 / 暂停</p>
            <p><strong>手势 2:</strong> 后退 5 秒</p>
            <p><strong>手势 3:</strong> 快进 5 秒</p>
            <p><strong>手势 4:</strong> 减小音量</p>
            <p><strong>手势 5:</strong> 增大音量</p>
        </div>
    </div>

    <!-- 需要为新元素添加一些样式 -->
    <style>
        /* ... (保留之前所有的样式) ... */
        .tool-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            align-items: center;
        }
        #player {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .controls-info {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>

    <script>
        // 获取所有需要的元素
        const webcam = document.getElementById('webcam'); // 修改了摄像头video的ID
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const resultCard = document.getElementById('result-card');
        const resultText = document.getElementById('result-text');
        const player = document.getElementById('player'); // 新增的播放器

        // --- WebSocket 和摄像头设置部分与之前完全相同 ---
        const ws = new WebSocket('ws://127.0.0.1:8000/ws');
        ws.onopen = () => console.log('成功连接到WebSocket服务器!');
        // ... (onclose, onerror) ...

        // !!! 核心修改在这里 !!!
        let lastActionTime = 0; // 用于防止手势重复触发
        const actionCooldown = 1000; // 1秒冷却时间

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            resultCard.classList.remove('waiting');
            resultText.textContent = `${data.gesture}`;
            resultText.style.color = data.confidence > 0.9 ? 'var(--primary-color)' : 'var(--danger-color)';

            const currentTime = Date.now();
            if (currentTime - lastActionTime < actionCooldown) {
                return; // 如果还在冷却时间内，则不执行任何操作
            }

            // 根据手势控制播放器
            if (data.confidence > 0.9) { // 只在置信度高时执行
                let actionTaken = false;
                switch (data.gesture) {
                    case 1:
                        player.paused ? player.play() : player.pause();
                        actionTaken = true;
                        break;
                    case 2:
                        player.currentTime -= 5;
                        actionTaken = true;
                        break;
                    case 3:
                        player.currentTime += 5;
                        actionTaken = true;
                        break;
                    case 4:
                        player.volume = Math.max(0, player.volume - 0.1);
                        actionTaken = true;
                        break;
                    case 5:
                        player.volume = Math.min(1, player.volume + 0.1);
                        actionTaken = true;
                        break;
                }
                if (actionTaken) {
                    lastActionTime = currentTime; // 如果执行了操作，则更新时间戳
                }
            }
        };

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcam.srcObject = stream;
        }

        function sendFrame() {
            canvas.width = webcam.videoWidth;
            canvas.height = webcam.videoHeight;
            ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
                if (ws.readyState === WebSocket.OPEN) ws.send(blob);
            }, 'image/jpeg', 0.5);
        }

        setupCamera().then(() => {
            webcam.onloadedmetadata = () => {
                setInterval(sendFrame, 100);
            };
        });
    </script>
</body>
</html>