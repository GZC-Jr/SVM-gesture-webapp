<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹åŠ¿é­”æ³•å±‹ - äº¤äº’ç‰ˆ</title>
    <style>
        :root {
            --primary-bg: #f0f4f8; --secondary-bg: #ffffff; --text-color: #333;
            --header-bg: #2c3e50; --header-text: #ecf0f1; --accent-color: #3498db;
            --success-color: #2ecc71; --error-color: #e74c3c;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.1); --border-radius: 8px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--primary-bg); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--header-bg); color: var(--header-text); padding: 20px 0; text-align: center; border-bottom: 4px solid var(--accent-color); }
        header h1 { margin: 0; font-size: 2.5rem; }
        header p { margin: 5px 0 0; font-size: 1.1rem; opacity: 0.9; }
        .main-app { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 30px; background: var(--secondary-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); }
        .video-container { flex: 1; min-width: 320px; display: flex; flex-direction: column; align-items: center; }
        .video-container h2 { margin-top: 0; color: var(--header-bg); }
        #webcam { width: 100%; max-width: 640px; height: auto; border-radius: var(--border-radius); background-color: #000; transform: scaleX(-1); }
        .result-container { flex: 1; min-width: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #status { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
        #gesture-label { font-size: 1.5rem; font-weight: bold; }
        #gesture-result { font-size: 8rem; font-weight: bold; color: var(--accent-color); margin: 10px 0; line-height: 1; min-height: 130px; }
        .interactive-zone { text-align: center; background: #e9ecef; padding: 20px; border-radius: var(--border-radius); margin-top: 20px; min-height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .interactive-zone h3 { margin: 0 0 10px 0; color: var(--header-bg); }
        .interactive-zone .placeholder { color: #7f8c8d; }
        .media-controls, .presentation-controls { font-size: 3rem; }
        .presentation-controls span { font-size: 1.5rem; vertical-align: middle; margin-left: 15px; }
        .features-section { margin-top: 40px; }
        .category-title { font-size: 2rem; color: var(--header-bg); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-bottom: 20px; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .feature-card { background-color: var(--secondary-bg); border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 25px; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 3px solid transparent; }
        .feature-card.active { border-color: var(--accent-color); transform: translateY(-5px); box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3); }
        .feature-card h3 { margin-top: 0; color: var(--accent-color); font-size: 1.5rem; }
        .activate-btn { background-color: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 15px; transition: background-color 0.3s; }
        .activate-btn:hover { background-color: #2980b9; }
        .feature-card.active .activate-btn { background-color: var(--error-color); }
        footer { text-align: center; padding: 20px; margin-top: 40px; color: #7f8c8d; }
    </style>
</head>
<body>

    <header>
        <h1>æ‰‹åŠ¿é­”æ³•å±‹ - äº¤äº’ç‰ˆ</h1>
        <p>ç‚¹å‡»ä¸‹æ–¹çš„ç©æ³•å¡ç‰‡ä»¥æ¿€æ´»äº’åŠ¨æ¨¡å¼</p>
    </header>

    <div class="container">
        <!-- ä¸»åº”ç”¨äº¤äº’åŒº -->
        <section class="main-app">
            <div class="video-container">
                <h2>å®æ—¶æ‘„åƒå¤´</h2>
                <video id="webcam" autoplay muted playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>
            <div class="result-container">
                <div id="status">æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...</div>
                <div id="gesture-label">å½“å‰è¯†åˆ«æ‰‹åŠ¿</div>
                <div id="gesture-result">...</div>
                <div class="interactive-zone" id="interactive-zone">
                    <p class="placeholder">è¯·å…ˆåœ¨ä¸‹æ–¹é€‰æ‹©ä¸€ä¸ªç©æ³•ä»¥å¼€å§‹äº’åŠ¨</p>
                </div>
            </div>
        </section>
        
        <!-- æ‰€æœ‰ç©æ³•å±•ç¤ºåŒº -->
        <section class="features-section">
            <h2 class="category-title">âš™ï¸ æ™ºèƒ½æ§åˆ¶ä¸æ•ˆç‡å·¥å…·</h2>
            <div class="feature-grid">
                <div class="feature-card" id="card-media-player">
                    <h3>ç©æ³•å››ï¼šéæ¥è§¦å¼åª’ä½“æ’­æ”¾å™¨</h3>
                    <p>ç”¨æ‰‹åŠ¿æ¥æ§åˆ¶è§†é¢‘æˆ–éŸ³ä¹çš„æ’­æ”¾ã€‚</p>
                    <button class="activate-btn" data-mode="media-player">æ¿€æ´»æ­¤æ¨¡å¼</button>
                </div>
                <div class="feature-card" id="card-presentation">
                    <h3>ç©æ³•äº”ï¼šæ¼”ç¤ºæ–‡ç¨¿é¥æ§å™¨</h3>
                    <p>åœ¨åšPPTæ¼”ç¤ºæ—¶ï¼Œç”¨æ‰‹åŠ¿ç¿»é¡µã€‚</p>
                    <button class="activate-btn" data-mode="presentation">æ¿€æ´»æ­¤æ¨¡å¼</button>
                </div>
            </div>
            
            <h2 class="category-title" style="margin-top: 40px;">ğŸ® æ¸¸æˆä¸å¨±ä¹ (å³å°†æ¨å‡º)</h2>
            <div class="feature-grid">
                <div class="feature-card" style="opacity: 0.6;"><h3>æ‰‹åŠ¿ç‰ˆâ€œæ°´æœå¿è€…â€</h3><p>å®ç°è¾ƒä¸ºå¤æ‚ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p></div>
                <div class="feature-card" style="opacity: 0.6;"><h3>æ‰‹åŠ¿â€œèŠ‚å¥å¤§å¸ˆâ€</h3><p>å®ç°è¾ƒä¸ºå¤æ‚ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p></div>
                <div class="feature-card" style="opacity: 0.6;"><h3>é­”æ³•å’’è¯­æ–½æ³•</h3><p>å®ç°è¾ƒä¸ºå¤æ‚ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p></div>
            </div>
            
        </section>
    </div>
    
    <footer>
        <p>Â© 2024 Gesture WebApp Project. Interactive Demo.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            const statusEl = document.getElementById('status');
            const gestureResultEl = document.getElementById('gesture-result');
            const interactiveZone = document.getElementById('interactive-zone');
            const activateBtns = document.querySelectorAll('.activate-btn');

            const WS_URL = 'ws://127.0.0.1:8000/ws';
            let ws;
            let activeMode = 'none';
            let intervalId;
            const FRAME_RATE = 10; // æ¯ç§’å‘åç«¯å‘é€10å¸§

            // äº¤äº’çŠ¶æ€å˜é‡
            let isPlaying = false;
            let slideNumber = 1;

            // å¯åŠ¨æ‘„åƒå¤´
            async function setupCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    video.addEventListener('loadeddata', () => {
                        statusEl.textContent = 'æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œæ­£åœ¨è¿æ¥åç«¯...';
                        statusEl.style.color = 'orange';
                        connectWebSocket();
                    });
                } catch (err) {
                    statusEl.textContent = 'âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æˆäºˆæƒé™å¹¶åˆ·æ–°é¡µé¢ã€‚';
                    statusEl.style.color = var(--error-color);
                    console.error("Error accessing camera: ", err);
                }
            }

            // è¿æ¥WebSocket
            function connectWebSocket() {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('Connected to WebSocket server.');
                    statusEl.textContent = 'âœ… åç«¯å·²è¿æ¥';
                    statusEl.style.color = var(--success-color);
                    // å¼€å§‹å®šæœŸå‘é€è§†é¢‘å¸§
                    intervalId = setInterval(sendFrame, 1000 / FRAME_RATE);
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.gesture !== undefined) {
                        gestureResultEl.textContent = data.gesture === null ? '?' : data.gesture;
                        handleGesture(data.gesture);
                    }
                };

                ws.onclose = () => {
                    console.log('WebSocket closed. Reconnecting...');
                    statusEl.textContent = 'ğŸ”Œ è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...';
                    statusEl.style.color = var(--error-color);
                    clearInterval(intervalId);
                    setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    statusEl.textContent = 'âŒ åç«¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚';
                    statusEl.style.color = var(--error-color);
                    ws.close();
                };
            }

            // å‘é€è§†é¢‘å¸§åˆ°åç«¯
            function sendFrame() {
                if (ws.readyState === WebSocket.OPEN) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    // å°†è§†é¢‘å¸§ç¿»è½¬å›æ¥ï¼Œå› ä¸ºCSSä¸­å·²ç»ç¿»è½¬äº†æ˜¾ç¤º
                    context.save();
                    context.scale(-1, 1);
                    context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
                    context.restore();
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5); // 0.5æ˜¯è´¨é‡å‹ç¼©
                    ws.send(JSON.stringify({ image: dataUrl }));
                }
            }

            // å¤„ç†æ”¶åˆ°çš„æ‰‹åŠ¿
            function handleGesture(gesture) {
                if (gesture === null || gesture === 'Unknown') return;
                
                switch (activeMode) {
                    case 'media-player':
                        if (gesture == '1') { isPlaying = !isPlaying; } // æ’­æ”¾/æš‚åœ
                        if (gesture == '5') { /* æ¨¡æ‹ŸéŸ³é‡+ */ }
                        if (gesture == '4') { /* æ¨¡æ‹ŸéŸ³é‡- */ }
                        updateMediaUI();
                        break;
                    case 'presentation':
                        if (gesture == '1' || gesture == '2') { slideNumber++; } // ä¸‹ä¸€é¡µ
                        if (gesture == '3') { slideNumber = Math.max(1, slideNumber - 1); } // ä¸Šä¸€é¡µ
                        if (gesture == '5') { slideNumber = 5; } // è·³è½¬åˆ°ç¬¬5é¡µ
                        updatePresentationUI();
                        break;
                }
            }
            
            // æ›´æ–°äº¤äº’åŒºåŸŸçš„UI
            function updateInteractiveUI(mode) {
                activeMode = mode;
                switch (mode) {
                    case 'media-player':
                        isPlaying = false;
                        updateMediaUI();
                        break;
                    case 'presentation':
                        slideNumber = 1;
                        updatePresentationUI();
                        break;
                    case 'none':
                    default:
                        interactiveZone.innerHTML = `<p class="placeholder">è¯·å…ˆåœ¨ä¸‹æ–¹é€‰æ‹©ä¸€ä¸ªç©æ³•ä»¥å¼€å§‹äº’åŠ¨</p>`;
                        break;
                }
            }
            
            function updateMediaUI() {
                interactiveZone.innerHTML = `
                    <h3>åª’ä½“æ’­æ”¾å™¨æ¨¡å¼</h3>
                    <div class="media-controls">${isPlaying ? 'âšâš' : 'â–¶'}</div>
                    <p>æ‰‹åŠ¿[1]æ’­æ”¾/æš‚åœ [5]éŸ³é‡+ [4]éŸ³é‡-</p>
                `;
            }

            function updatePresentationUI() {
                interactiveZone.innerHTML = `
                    <h3>æ¼”ç¤ºæ–‡ç¨¿æ¨¡å¼</h3>
                    <div class="presentation-controls">
                        ğŸ“œ<span>ç¬¬ ${slideNumber} é¡µ</span>
                    </div>
                    <p>æ‰‹åŠ¿[1/2]ä¸‹ä¸€é¡µ [3]ä¸Šä¸€é¡µ [5]è·³è‡³ç¬¬5é¡µ</p>
                `;
            }
            
            // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            activateBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const selectedMode = btn.dataset.mode;
                    
                    if (btn.parentElement.classList.contains('active')) {
                        // å¦‚æœå·²ç»æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œåˆ™å–æ¶ˆ
                        btn.parentElement.classList.remove('active');
                        btn.textContent = 'æ¿€æ´»æ­¤æ¨¡å¼';
                        updateInteractiveUI('none');
                    } else {
                        // ç§»é™¤æ‰€æœ‰å…¶ä»–çš„æ¿€æ´»çŠ¶æ€
                        document.querySelectorAll('.feature-card.active').forEach(card => {
                            card.classList.remove('active');
                            card.querySelector('.activate-btn').textContent = 'æ¿€æ´»æ­¤æ¨¡å¼';
                        });
                        
                        // æ¿€æ´»å½“å‰ç‚¹å‡»çš„
                        btn.parentElement.classList.add('active');
                        btn.textContent = 'åœæ­¢æ¨¡å¼';
                        updateInteractiveUI(selectedMode);
                    }
                });
            });

            // å¯åŠ¨æµç¨‹
            setupCamera();
        });
    </script>
</body>
</html>